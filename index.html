<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .navbar { display: flex; align-items: center; background: #333; color: #fff; padding: 10px; }
        .logo { display: flex; align-items: center; }
        .logo img { height: 40px; margin-right: 10px; }
        .menu-icon { margin-left: auto; cursor: pointer; font-size: 24px; }
        .sidebar { position: fixed; left: -250px; width: 250px; height: 100%; background: #222; color: #fff; padding: 20px; transition: 0.3s; }
        .sidebar.active { left: 0; }
        .main-content { padding: 20px; }
        .buttons button, .certificate button { margin: 5px; padding: 10px; cursor: pointer; }
        .gauges { display: flex; gap: 20px; margin-top: 20px; }
        .gauge { width: 100px; height: 100px; border-radius: 50%; background: #ddd; display: flex; justify-content: center; align-items: center; position: relative; }
        .gauge__fill { position: absolute; width: 100%; height: 100%; background: #28a745; transform: rotate(0turn); transform-origin: bottom; transition: 0.5s ease-in-out; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="aarislogo.jpg" alt="Logo">
            <span>Aampal</span>
        </div>
        <div class="menu-icon" id="menuIcon">&#9776;</div>
    </nav>
    <div class="sidebar" id="sidebar">
        <i class="fa-solid fa-xmark" id="close"></i>
        <h1>Options</h1>
        <input type="text" id="commandInput" placeholder="Enter command" disabled>
        <button id="sendCommand" disabled>Send</button>
        <h3>Received Data:</h3>
        <div id="log"></div>
    </div>
    <div class="main-content">
        <p id="status">Status: Disconnected</p>
        <div class="buttons">
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
            <button id="liveTrigger" disabled>Trigger @live=100</button>
        </div>
        <div class="gauges">
            <div class="gauge"><div class="gauge__fill" id="humidityFill"></div><span id="humidityValue">0% Humidity</span></div>
            <div class="gauge"><div class="gauge__fill" id="temperatureFill"></div><span id="temperatureValue">0°C Temperature</span></div>
        </div>
        <div class="certificate">
            <button id="Certificate" disabled>Trigger @cert?</button>
            <div id="display-certificate"></div>
        </div>
    </div>
    <script>
        document.getElementById('menuIcon').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));
        document.getElementById('close').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));

        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const CHARACTERISTIC_UUID_RX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
        const CHARACTERISTIC_UUID_TX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
        let bleDevice = null, server = null, rxCharacteristic = null, txCharacteristic = null;

        async function connectBLE() {
            try {
                bleDevice = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [SERVICE_UUID] });
                document.getElementById("status").textContent = "Status: Connecting...";
                server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                rxCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID_RX);
                txCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID_TX);
                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener("characteristicvaluechanged", handleNotifications);
                document.getElementById("status").textContent = "Status: Connected!";
                document.getElementById("commandInput").disabled = false;
                document.getElementById("sendCommand").disabled = false;
                document.getElementById("connectBtn").disabled = true;
                document.getElementById("disconnectBtn").disabled = false;
                document.getElementById("liveTrigger").disabled = false;
                document.getElementById("Certificate").disabled = false;
                bleDevice.addEventListener("gattserverdisconnected", onDisconnected);
            } catch (error) {
                alert("Failed to connect: " + error.message);
                document.getElementById("status").textContent = "Status: Connection Failed";
            }
        }

        async function sendCommand(command) {
            if (!rxCharacteristic) return alert("Not connected!");
            try { await rxCharacteristic.writeValue(new TextEncoder().encode(command)); }
            catch (error) { console.error("Send Error:", error); }
        }

        function handleNotifications(event) {
            let value = new TextDecoder().decode(event.target.value);
            document.getElementById("log").innerHTML += `<div>${value}</div>`;
            processLiveData(value);
            if (value.startsWith("#cert=")) document.getElementById("display-certificate").textContent = "Certificate Data: " + value.slice(6);
        }

        function processLiveData(data) {
            let match = data.match(/Live=([\d.]+),([\d.]+)/);
            if (match) {
                setGaugeValue(document.getElementById("humidityFill"), parseFloat(match[2]));
                setGaugeValue(document.getElementById("temperatureFill"), parseFloat(match[1]));
                document.getElementById("humidityValue").textContent = match[2] + "% Humidity";
                document.getElementById("temperatureValue").textContent = match[1] + "°C Temperature";
            }
        }

        function setGaugeValue(fill, value) { fill.style.transform = `rotate(${0.5 * (value / 100)}turn)`; }

        function disconnectBLE() { if (bleDevice?.gatt.connected) bleDevice.gatt.disconnect(); }
        function onDisconnected() { document.getElementById("status").textContent = "Status: Disconnected"; }

        document.getElementById("connectBtn").addEventListener("click", connectBLE);
        document.getElementById("disconnectBtn").addEventListener("click", disconnectBLE);
        document.getElementById("sendCommand").addEventListener("click", () => sendCommand(document.getElementById("commandInput").value.trim()));
        document.getElementById("liveTrigger").addEventListener("click", () => sendCommand("@live=100"));
        document.getElementById("Certificate").addEventListener("click", () => sendCommand("@cert?"));
    </script>
</body>
</html>
