<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .sidebar { position: fixed; left: -250px; width: 250px; height: 100%; background: #333; color: white; transition: 0.3s; padding: 10px; }
        .sidebar.active { left: 0; }
        .cert-container { display: none; padding: 10px; background: #f1f1f1; border: 1px solid #ccc; margin-top: 10px; }
    </style>
</head>
<body>
    <button id="menuToggle">â˜° Menu</button>
    <div class="sidebar" id="sidebar">
        <button id="closeSidebar">Close</button>
        <h2>BLE Console</h2>
        <input type="text" id="commandInput" placeholder="Enter command" disabled>
        <button id="sendCommand" disabled>Send</button>
        <h3>Received Data:</h3>
        <div id="log"></div>
        <div id="certContainer" class="cert-container"></div>
    </div>
    
    <h1>BLE Dashboard</h1>
    <p id="status">Status: Disconnected</p>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
    <button id="liveTrigger" disabled>Trigger @live=100</button>
    <button id="certBtn" disabled>Trigger @cert?</button>
    
    <script>
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
        const TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
        let device, server, rxChar, txChar;

        document.getElementById('menuToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));
        document.getElementById('closeSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.remove('active'));
        
        async function connectBLE() {
            try {
                device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [SERVICE_UUID] });
                server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                rxChar = await service.getCharacteristic(RX_UUID);
                txChar = await service.getCharacteristic(TX_UUID);
                txChar.addEventListener("characteristicvaluechanged", handleNotifications);
                await txChar.startNotifications();
                updateUI(true);
                device.addEventListener("gattserverdisconnected", onDisconnected);
            } catch (error) { alert("Connection failed: " + error.message); }
        }

        function handleNotifications(event) {
            let data = new TextDecoder().decode(event.target.value);
            document.getElementById("log").innerHTML += `<p>${data}</p>`;
            let certMatch = data.match(/#cert=(.*)/);
            if (certMatch) {
                document.getElementById("certContainer").textContent = "Certificate: " + certMatch[1].trim();
                document.getElementById("certContainer").style.display = "block";
            }
        }

        async function sendCommand(command) {
            if (!rxChar) return alert("Not connected!");
            await rxChar.writeValue(new TextEncoder().encode(command));
        }

        function onDisconnected() { updateUI(false); }
        function updateUI(connected) {
            document.getElementById("status").textContent = connected ? "Connected" : "Disconnected";
            document.getElementById("connectBtn").disabled = connected;
            document.getElementById("disconnectBtn").disabled = !connected;
            document.getElementById("liveTrigger").disabled = !connected;
            document.getElementById("certBtn").disabled = !connected;
            document.getElementById("commandInput").disabled = !connected;
            document.getElementById("sendCommand").disabled = !connected;
            if (!connected) document.getElementById("certContainer").style.display = "none";
        }

        document.getElementById("connectBtn").addEventListener("click", connectBLE);
        document.getElementById("disconnectBtn").addEventListener("click", () => device?.gatt.disconnect());
        document.getElementById("sendCommand").addEventListener("click", () => sendCommand(document.getElementById("commandInput").value));
        document.getElementById("liveTrigger").addEventListener("click", () => sendCommand("@live=100"));
        document.getElementById("certBtn").addEventListener("click", () => sendCommand("@cert?"));
    </script>
</body>
</html>
